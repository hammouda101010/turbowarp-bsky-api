<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <title>TurboButterfly OAuth Callback</title>
    <link rel="stylesheet" href="src/styles/auth.css">
    <link rel="apple-touch-icon" sizes="180x180" href="static/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="static/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="static/icons/favicon-16x16.png">
    <link rel="manifest" href="static/icons/site.webmanifest">
  </head>
  <body>
    <p id="auth_result">Processing authentication...</p>
  </body>
  <script>
    window.onload = function () {
      // Step 1: Get the query parameters from the search (URL)
      const queryParams = new URLSearchParams(window.location.search); // Get the query parameters

      if (queryParams) {
        // Step 2: Extract parameters: iss, state, and code
        const iss = queryParams.get('iss'); // The authorization server's URL (issuer)
        const state = queryParams.get('state'); // CSRF protection value (match with request state)
        const code = queryParams.get('code'); // Authorization code

        if (iss && state && code) {
          console.log('Issuer:', iss);
          console.log('State:', state);
          console.log('Authorization Code:', code);

          // Step 4: Send the data back to the parent window via postMessage
          window.opener.postMessage({ type: 'oauthCallback', iss, state, code }, '*');

          // Step 5: Close the popup window after sending the data
          window.close();
        } else {
          console.error('Missing parameters: iss, state, or code');
        }
      } else {
        console.error('No OAuth response query parameters found.');
      }
    };
  </script>
</head>
<body>
  <p id="auth_result">Processing OAuth Response...</p>
</body>
</html>